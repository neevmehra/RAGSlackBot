<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Oracle Support Agent</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    margin: 0; padding: 0;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }
  .container {
    max-width: 800px;
    background: white;
    padding: 2rem;
    margin: 2rem 1rem;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgb(0 0 0 / 0.1);
    display: flex;
    flex-direction: column;
  }
  h1 {
    text-align: center;
    color: #1e293b;
    margin-bottom: 1rem;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
    color: #334155;
  }
  input[type="file"],
  input[type="text"],
  select {
    width: 100%;
    margin-top: 0.4rem;
    padding: 0.6rem;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 1rem;
    color: #475569;
    transition: border-color 0.2s ease;
  }
  input[type="file"]:focus,
  input[type="text"]:focus,
  select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgb(59 130 246 / 0.3);
  }
  input[type="submit"] {
    margin-top: 1.8rem;
    width: 100%;
    padding: 0.75rem;
    font-size: 1.1rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.25s ease;
  }
  input[type="submit"]:hover {
    background: #2563eb;
  }
  /* Chat UI */
  #chat-container {
    margin-top: 3rem;
    display: flex;
    flex-direction: column;
    height: 400px;
    border: 1px solid #cbd5e1;
    border-radius: 10px;
    background: #f1f5f9;
  }
  #chat-log {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    font-size: 1rem;
    color: #334155;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  #chat-input-container {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-top: 1px solid #cbd5e1;
    background: white;
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
  }
  #chat-input {
    flex: 1;
    padding: 0.7rem 1rem;
    font-size: 1rem;
    border: 1px solid #cbd5e1;
    border-radius: 25px;
    transition: border-color 0.2s ease;
  }
  #chat-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgb(59 130 246 / 0.3);
  }
  #chat-send-btn {
    padding: 0 1.5rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  #chat-send-btn:hover {
    background: #2563eb;
  }
  .message {
    max-width: 80%;
    padding: 0.8rem 1.2rem;
    border-radius: 18px;
    white-space: pre-wrap; /* preserve whitespace & newlines */
    word-wrap: break-word;
    line-height: 1.4;
  }
  .message.user {
    align-self: flex-end;
    background: #3b82f6;
    color: white;
    border-bottom-right-radius: 4px;
  }
  .message.bot {
    align-self: flex-start;
    background: #e2e8f0;
    color: #334155;
    border-bottom-left-radius: 4px;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Oracle Support Agent</h1>

  <form id="upload-form" action="/embed" method="post" enctype="multipart/form-data" target="hidden_iframe">
    <label for="file">Select JSON, PDF, or CSV file:</label>
    <input type="file" name="file" id="file" accept=".json, .pdf" required />

    <label for="schema">Select Team (Schema):</label>
    <select name="schema" id="schema" required>
      <option value="">--Choose a team--</option>
      <option value="TeamA">TeamA</option>
      <option value="CSS">CSS</option>
    </select>

    <label for="table_name">Table name:</label>
    <input type="text" name="table_name" id="table_name" placeholder="e.g., tickets" required />

    <input type="submit" value="Upload & Embed" />
  </form>

  <div id="upload-status" style="margin-top: 1rem; color: green;"></div>

  <!-- Hidden iframe to prevent page reload on form submit -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <hr style="margin: 2rem 0;" />

  <h2>Chat with AI Support Agent</h2>

  <div id="chat-container">
    <div id="chat-log"></div>
    <div id="chat-input-container">
      <input type="text" id="chat-input" placeholder="Ask your question here..." autocomplete="off" />
      <button id="chat-send-btn">Send</button>
    </div>
  </div>
</div>

<script>
  const chatLog = document.getElementById('chat-log');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const uploadForm = document.getElementById('upload-form');
  const uploadStatus = document.getElementById('upload-status');

  // Handle form submit to show status without page reload
  uploadForm.addEventListener('submit', () => {
    uploadStatus.textContent = 'Uploading and embedding... please wait.';
  });

  // Listen for iframe load to confirm upload finished
  document.querySelector('iframe[name="hidden_iframe"]').addEventListener('load', () => {
    uploadStatus.textContent = 'Upload & embedding complete!';
  });

  // Strip simple markdown **bold**
  function stripMarkdown(text) {
    return text.replace(/\*\*(.*?)\*\*/g, '$1');
  }

  // Add message to chat log, preserve line breaks, strip markdown
  function addMessage(text, sender) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', sender);

    // Strip markdown, escape HTML special chars
    let cleanedText = stripMarkdown(text);
    cleanedText = cleanedText
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

    // Replace newlines with <br>
    const htmlText = cleanedText.replace(/\n/g, "<br>");

    msgDiv.innerHTML = htmlText;
    chatLog.appendChild(msgDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  // Send chat message to backend /ask
  async function sendMessage() {
    const question = chatInput.value.trim();
    if (!question) return;

    addMessage(question, 'user');
    chatInput.value = '';
    chatInput.disabled = true;
    chatSendBtn.disabled = true;

    try {
      const response = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          question,
          schema: document.getElementById('schema').value
        }),
      });
      const data = await response.json();
      if (data.answer) {
        addMessage(data.answer, 'bot');
      } else {
        addMessage('No response from server.', 'bot');
      }
    } catch (err) {
      addMessage('Error contacting server.', 'bot');
    } finally {
      chatInput.disabled = false;
      chatSendBtn.disabled = false;
      chatInput.focus();
    }
  }

  chatSendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
</script>

</body>
</html>
